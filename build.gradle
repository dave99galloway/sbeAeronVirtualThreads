plugins {
    id 'java'
    id 'application'
    id 'com.google.protobuf' version '0.9.4'
}

apply plugin: 'java-library'

application {
    mainClass = 'com.playground.sbeaeronvirtualthreads.Main'
}

group = 'com.playground'
version = '1.0-SNAPSHOT'

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
}

repositories {
    mavenCentral()
}

sourceSets {
    main {
        java {
            srcDirs = ['src/main/java', 'build/generated-src', 'build/generated/source/proto/main/java']
        }
    }
    test {
        java {
            srcDirs = ['src/test/java']
        }
        resources {
            srcDirs = ['src/test/resources']
        }
    }
    cucumber {
        java {
            srcDirs = ['src/cucumber/java']
        }
        resources {
            srcDirs = ['src/cucumber/resources']
        }
        compileClasspath += main.output
        runtimeClasspath += main.output
    }
}

configurations {
    cucumberImplementation.extendsFrom implementation
    cucumberRuntimeOnly.extendsFrom runtimeOnly
}

dependencies {
    // Aeron for low-latency messaging
    implementation 'io.aeron:aeron-all:1.44.1'
    
    // SBE for efficient binary encoding
    implementation 'uk.co.real-logic:sbe-all:1.32.0'
    
    // Protobuf
    implementation 'com.google.protobuf:protobuf-java:3.25.1'
    
    // Jackson for JSON
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.16.0'
    
    // JMH for benchmarking
    implementation 'org.openjdk.jmh:jmh-core:1.37'
    annotationProcessor 'org.openjdk.jmh:jmh-generator-annprocess:1.37'
    
    // Main dependencies
    implementation 'org.slf4j:slf4j-api:2.0.9'
    implementation 'ch.qos.logback:logback-classic:1.4.11'
    
    // JUnit 5 dependencies
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.10.1'
    testImplementation 'org.junit.jupiter:junit-jupiter-params:5.10.1'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.10.1'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher:1.10.1'
    
    // AssertJ for fluent assertions
    testImplementation 'org.assertj:assertj-core:3.24.2'
    
    // Cucumber dependencies
    cucumberImplementation 'io.cucumber:cucumber-java:7.14.1'
    cucumberImplementation 'io.cucumber:cucumber-junit-platform-engine:7.14.1'
    cucumberImplementation 'org.junit.platform:junit-platform-suite:1.10.1'
    cucumberImplementation 'org.junit.jupiter:junit-jupiter-api:5.10.1'
    cucumberRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.10.1'
    cucumberRuntimeOnly 'org.junit.platform:junit-platform-launcher:1.10.1'
    
    // AssertJ for Cucumber tests
    cucumberImplementation 'org.assertj:assertj-core:3.24.2'
}

test {
    useJUnitPlatform()
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
    }
}

// Task to run Cucumber tests
task cucumber(type: Test) {
    description = 'Run Cucumber BDD tests'
    group = 'verification'
    
    testClassesDirs = sourceSets.cucumber.output.classesDirs
    classpath = sourceSets.cucumber.runtimeClasspath
    
    useJUnitPlatform()
    
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
    }
    
    jvmArgs = [
        '--add-opens', 'java.base/sun.nio.ch=ALL-UNNAMED',
        '--add-opens', 'java.base/java.util.zip=ALL-UNNAMED'
    ]
    
    systemProperty 'cucumber.plugin', 'pretty, html:build/reports/cucumber/cucumber.html, json:build/reports/cucumber/cucumber.json'
    systemProperty 'cucumber.glue', 'com.playground.sbeaeronvirtualthreads.cucumber'
    systemProperty 'cucumber.features', 'src/cucumber/resources'
}

// Task to run only JUnit tests
task unitTest(type: Test) {
    description = 'Run JUnit unit tests'
    group = 'verification'
    
    testClassesDirs = sourceSets.test.output.classesDirs
    classpath = sourceSets.test.runtimeClasspath
    
    useJUnitPlatform()
    
    jvmArgs = [
        '--add-opens', 'java.base/sun.nio.ch=ALL-UNNAMED',
        '--add-opens', 'java.base/java.util.zip=ALL-UNNAMED'
    ]
    
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat "full"
    }
}

tasks.named('check') {
    dependsOn cucumber, unitTest
}

// Protobuf configuration
protobuf {
    protoc {
        artifact = 'com.google.protobuf:protoc:3.25.1'
    }
    generateProtoTasks {
        all().each { task ->
            task.builtins {
                java {}
            }
        }
    }
}

// SBE code generation task
task generateSbe(type: JavaExec) {
    group = 'build'
    description = 'Generate SBE message codecs'
    
    classpath = configurations.runtimeClasspath
    mainClass = 'uk.co.real_logic.sbe.SbeTool'
    
    args = [
        'src/main/resources/sbe-schema.xml'
    ]
    
    systemProperty 'sbe.output.dir', 'build/generated-src'
    systemProperty 'sbe.target.language', 'Java'
    systemProperty 'sbe.java.generate.interfaces', 'true'
    
    doFirst {
        mkdir 'build/generated-src'
    }
}

compileJava.dependsOn generateSbe, generateProto

// JMH Benchmark task
task jmhBenchmark(type: JavaExec) {
    group = 'benchmark'
    description = 'Run JMH benchmarks'
    
    classpath = sourceSets.test.runtimeClasspath
    mainClass = 'org.openjdk.jmh.Main'
    
    args = [
        '.*Benchmark.*',
        '-f', '1',
        '-wi', '3',
        '-i', '5',
        '-r', '1',
        '-w', '1',
        '-rf', 'json',
        '-rff', 'build/reports/jmh-results.json'
    ]
}
